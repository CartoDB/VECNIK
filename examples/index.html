<!DOCTYPE html>
<html>
<head>
<title>Vecnik</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<link rel="stylesheet" href="lib/leaflet08/leaflet.css">
<style type="text/css">
html, body {
  border: 0;
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

#map {
  height: 100%;
}

#code {
  color: #000;
  background-color: rgba(255, 255, 255, 0.85);
  position: absolute;
  left: 10px;
  top: 75px;
  bottom: 10px;
  padding: 5px;
  border: 1px solid #ccc;
  font-family: monospace;
  font-size: 12px;
  width: 350px;
  outline: none;
  z-index: 10;
}

#code .highlight {
  font-family: monospace;
  font-size: 19px;
}
</style>

<script src="lib/leaflet08/leaflet-src.js"></script>
<script src="../vecnik.js"></script>
<script src="lib/underscore.js"></script>
<script src="lib/carto.js"></script>
<script>

var map, code;

document.addEventListener('DOMContentLoaded', function() {
  map = new L.Map('map').setView([40.735291, -73.990731], 16);
  new L.TileLayer('http://otile2.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png', { maxNativeZoom: 19, maxZoom: 21 }).addTo(map);

  var provider = new VECNIK.CartoDB.API({
    user: 'pluto',
    table: 'mn_mappluto_13v1',
    columns: ['numfloors'],
    debug: false
  });

  var shader = new VECNIK.CartoShader();

  var renderer = new VECNIK.Renderer({ shader: shader });

  var vlayer = new VECNIK.Layer({
    provider: provider,
    renderer: renderer
  });

  vlayer.addTo(map);
  L.control.layers({}, { VECNIK: vlayer }).addTo(map);

  code = document.getElementById('code');

  var timer, oldCode = '';
  code.addEventListener('keyup', function() {
    if (oldCode === code.value) {
      return;
    }
    clearTimeout(timer);
    timer = setTimeout(function() {
      shader.update(oldCode = code.value);
      // TODO: redraw may not go through the whole load/parse process
      vlayer.redraw();
    }, 300);
  });

  shader.update(oldCode = code.value);
  // TODO: redraw may not go through the whole load/parse process
  vlayer.redraw();
});
</script>
</head>

<body>
<div id="map"></div>

<textarea id="code">
#layer {
  polygon-fill: rgba(0, 0, 0, 0.1);
  line-color: white;
  line-width: 4;
  [numfloors > 10] {
    polygon-fill: rgba(255, 0, 0, 0.88);
  }
}
#layer::pass2 {
  polygon-fill: rgba(0, 0, 0, 0.0);
  line-width: 1;
  line-color: black;
}
</textarea>
</body>
</html>