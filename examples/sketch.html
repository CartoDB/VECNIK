<!DOCTYPE html>
<html>
<head>
<title>Vecnik - Sketch Renderer</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<link rel="stylesheet" href="lib/leaflet08/leaflet.css">
<style type="text/css">
html, body {
  border: 0;
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
}
#map {
  height: 100%;
}
</style>
<script src="lib/leaflet08/leaflet-src.js"></script>

<script src="../src/polyfills.js"></script>
<script src="../src/core/core.js"></script>
<script src="../src/core/events.js"></script>
<script src="../src/core/model.js"></script>
<script src="../src/core/settings.js"></script>
<script src="../src/tile.js"></script>
<script src="../src/layer.js"></script>
<script src="../src/mercator.js"></script>
<script src="../src/reader/geojson.js"></script>
<script src="../src/profiler.js"></script>
<script src="../src/renderer.js"></script>
<script src="../src/shader.js"></script>

<script src="../src/provider/cartodb.sql.js"></script>
<script src="../src/provider/cartodb.js"></script>

<script src="lib/underscore.js"></script>
<script src="lib/carto.js"></script>
</head>

<body>
<div id="map"></div>

<script>
var map = new L.Map('map').setView([40.735291, -73.990731], 16);
new L.TileLayer('http://otile2.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png', { maxNativeZoom: 19, maxZoom: 21 }).addTo(map);

var provider = new VECNIK.CartoDB.API({
  user: 'pluto',
  table: 'mn_mappluto_13v1',
  columns: ['numfloors'],
  debug: false
});

var layers = VECNIK.CartoShader.create([
  '#layer {',
  ' polygon-fill: rgba(0, 0, 0, 0.1);',
  ' line-color: white;',
  ' line-width: 4;',
  ' [numfloors > 10] {',
  '    polygon-fill: rgba(255, 0, 0,0.88);',
  ' }',
  '}',
  '#layer::pass2 {',
  ' polygon-fill: rgba(0, 0, 0, 0.0);',
  ' line-width: 1;',
  ' line-color: black;',
  '}'
].join('\n'));

var renderer = new VECNIK.Renderer({ shader: layers });

var vlayer = new VECNIK.Layer({
  provider: provider,
  renderer: renderer
});

vlayer.addTo(map);
L.control.layers({}, { VECNIK: vlayer }).addTo(map);
</script>
</body>
</html>


<script>
function SketchRender() {
  var RND_FACTOR = 1;
  var rnd = function() {
    return RND_FACTOR * (2*Math.random()-1);
  };

  function sketchLine(context, p0, p1) {
    var
      dx = p1.x-p0.x,
      dy = p1.y-p0.y;

    dx *= 0.15;
    dy *= 0.15;

    for(var i = 0; i < 3; ++i) {
      context.strokeStyle = 'rgba(55, 0, 130, '+ (0.01 + 0.3*Math.random()) +')';
      context.beginPath();
      context.lineWidth = 0.5*(1 + (3-i)) ;//0.3 + rnd();
      context.moveTo(p0.x - dx + rnd(), p0.y - dy + rnd());
      context.lineTo(p1.x + dx + rnd(), p1.y + dy + rnd());
      context.closePath();
      context.stroke();
    }
  }

  var primitive_render = this.primitive_render = {
    Polygon: function(context, coordinates) {
      var c = coordinates;
      var xmin, xmax,ymin, ymax;
      xmin = xmax = c[0].x;
      ymin = ymax = c[0].y;
      //context.shadowColor = 'rgba(0, 0, 0, 0.5)';
      for(var i=1; i < c.length; ++i) {
        context.shadowBlur = 10;
        context.shadowColor = 'rgba(0, 0, 180, 0.6)';
         sketchLine(context, c[i-1], c[i]);
         var p = c[i];
         xmin = Math.min(xmin, p.x);
         xmax = Math.max(xmax, p.x);
         ymin = Math.min(ymin, p.y);
         ymax = Math.max(ymax, p.y);

      }
    },
    LineString: function(context, coordinates) {
      var p = primitive_render.Polygon;
      p(context, coordinates);
    }
  };
}

// SketchRender.prototype = new VECNIK.Renderer();
</script>