<!DOCTYPE html>
<html>
<head>
<title>Vecnik - Lines</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="lib/leaflet08/leaflet.css">
<style type="text/css">
html, body {
  border: 0;
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

#map {
  height: 100%;
}

#tooltip {
  position: absolute;
  padding: 5px 10px;
  background: rgba(255, 255, 255, 0.7);
  font-family: sans-serif;
  font-size: 14px;
  z-index: 100;
  pointer-events: none;
}
</style>

<script src="lib/leaflet08/leaflet-src.js"></script>
<script src="../vecnik.debug.js"></script>
<script src="lib/underscore.js"></script>
<script src="lib/carto.js"></script>
<script>
// https://viz2.cartodb.com/viz/78c9ecce-ed61-11e3-b81e-0e73339ffa50/public_map

var viz = {
  "id": "78c9ecce-ed61-11e3-b81e-0e73339ffa50",
  "version": "0.1.0",
  "title": "vecnik_lines",
  "description": null,
  "scrollwheel": true,
  "legends": true,
  "url": null,
  "map_provider": "leaflet",
  "bounds": [
    [6.620957270326323, -43.33007812499999],
    [51.536085601784755, 69.169921875]
  ],
  "center": [31.728167146023935, 12.919921874999998],
  "zoom": 5,
  "updated_at": "2014-06-06T10:02:06+00:00",
  "layers": [{
    "options": {
      "visible": true,
      "type": "Tiled",
      "name": "Warden (Mapbox)",
      "className": "mapbox_warden",
      "base_type": "mapbox_warden",
      "urlTemplate": "https://dnv9my2eseobd.cloudfront.net/v3/cartodb.map-uulyudas/{z}/{x}/{y}.png",
      "read_only": true,
      "maxZoom": 21,
      "attribution": "Mapbox <a href='http://mapbox.com/about/maps' target='_blank'>Terms &amp; Feedback</a>",
      "order": 0,
      "id": 2696
    },
    "infowindow": null,
    "tooltip": null,
    "id": "03de8b49-1078-4102-bf48-5d21cae93945",
    "order": 0,
    "type": "tiled"
  }, {
    "type": "namedmap",
    "order": 1,
    "options": {
      "type": "namedmap",
//      "user_name": "viz2",
      "user_name": "osmbuildings",
      "tiler_protocol": "http",
      "tiler_domain": "cartodb.com",
      "tiler_port": "80",
      "cdn_url": {
        "http": "api.cartocdn.com",
        "https": "cartocdn.global.ssl.fastly.net"
      },
      "named_map": {
        "name": "tpl_78c9ecce_ed61_11e3_b81e_0e73339ffa50",
        "stat_tag": "78c9ecce-ed61-11e3-b81e-0e73339ffa50",
        "params": {
          "layer0": 1
        },
        "layers": [{
//          "layer_name": "table_50m_rivers_lake_cen",
          "layer_name": "table_50m_rivers_lake_centerlines_with_scale_r",
          "interactivity": "cartodb_id",
          "visible": true,
          "infowindow": {
            "fields": [{
              "name": "dissolve",
              "title": true,
              "position": 2
            }, {
              "name": "featurecla",
              "title": true,
              "position": 3
            }, {
              "name": "name1",
              "title": true,
              "position": 4
            }, {
              "name": "note",
              "title": true,
              "position": 5
            }, {
              "name": "scalerank",
              "title": true,
              "position": 6
            }, {
              "name": "strokeweig",
              "title": true,
              "position": 7
            }],
            "template_name": "table/views/infowindow_light",
            "template": "<div class=\"cartodb-popup v2\">\n  <a href=\"#close\" class=\"cartodb-popup-close-button close\">x</a>\n  <div class=\"cartodb-popup-content-wrapper\">\n    <div class=\"cartodb-popup-content\">\n      {{#content.fields}}\n        {{#title}}<h4>{{title}}</h4>{{/title}}\n        {{#value}}\n          <p {{#type}}class=\"{{ type }}\"{{/type}}>{{{ value }}}</p>\n        {{/value}}\n        {{^value}}\n          <p class=\"empty\">null</p>\n        {{/value}}\n      {{/content.fields}}\n    </div>\n  </div>\n  <div class=\"cartodb-popup-tip-container\"></div>\n</div>\n",
            "alternative_names": {},
            "width": 226,
            "maxHeight": 180
          },
          "legend": {
            "type": "category",
            "show_title": false,
            "title": "",
            "template": "",
            "items": [{
              "name": 6,
              "visible": true,
              "value": "#A6CEE3"
            }, {
              "name": 3,
              "visible": true,
              "value": "#1F78B4"
            }, {
              "name": 4,
              "visible": true,
              "value": "#B2DF8A"
            }, {
              "name": 5,
              "visible": true,
              "value": "#33A02C"
            }, {
              "name": 2,
              "visible": true,
              "value": "#FB9A99"
            }, {
              "name": 1,
              "visible": true,
              "value": "#E31A1C"
            }, {
              "name": 0,
              "visible": true,
              "value": "#FDBF6F"
            }]
          }
        }]
      }
    }
  }],
  "overlays": [{
    "type": "loader",
    "order": 8,
    "options": {
      "display": true,
      "x": 20,
      "y": 150
    },
    "template": "<div class=\"loader\" original-title=\"\"></div>"
  }, {
    "type": "zoom",
    "order": 6,
    "options": {
      "display": true,
      "x": 20,
      "y": 20
    },
    "template": "<a href=\"#zoom_in\" class=\"zoom_in\">+</a> <a href=\"#zoom_out\" class=\"zoom_out\">-</a>"
  }]
};

var cartocss =
'#layer {\n'+
'  line-color: rgb(100, 100, 200);\n'+
'  line-width: [strokeweig]*5;\n'+
'}'+
'#layer [scalerank = 6] {'+
'  line-color: #A6CEE3;'+
'}'+
'#layer [scalerank = 3] {'+
'  line-color: #1F78B4;'+
'}'+
'#layer [scalerank = 4] {'+
'  line-color: #B2DF8A;'+
'}'+
'#layer [scalerank = 5] {'+
'  line-color: #33A02C;'+
'}'+
'#layer [scalerank = 2] {'+
'  line-color: #FB9A99;'+
'}'+
'#layer [scalerank = 1] {'+
'  line-color: #E31A1C;'+
'}'+
'#layer [scalerank = 0] {'+
'  line-color: #FDBF6F;'+
'}'+
'#layer::hover {\n'+
'  line-color: #ff00ff;\n'+
'  line-width: 10;\n'+
'}'
;

var map;

var providerOptions = viz.layers[1].options;

var provider = new VECNIK.CartoDB.API(VECNIK.GeoJSON, {
  user: providerOptions.user_name,
  table: providerOptions.named_map.layers[0].layer_name,
  columns: ['dissolve', 'featurecla', 'name1', 'note', 'scalerank', 'strokeweig'],
  debug: false,
  bufferSize: 50
});

var shader = new VECNIK.CartoShader(cartocss);

var vlayer = new VECNIK.Layer({
  provider: provider,
  renderer: new VECNIK.Renderer({ shader: shader }),
  interaction: true,
  detectRetina: true
});

document.addEventListener('DOMContentLoaded', function() {
  map = new L.Map('map').setView(viz.center, viz.zoom-1);

  var baseTiles = viz.layers[0].options;

  new L.TileLayer(
    baseTiles.urlTemplate,
    {
      subdomains: '1234',
      name: baseTiles.name,
      attribution: baseTiles.attribution,
      maxZoom: 20
    })
    .addTo(map);

  var tooltip = document.querySelector('#tooltip');

  vlayer.addTo(map)
    .on('featureEnter', function(e) {
      tooltip.style.display = 'block';
      var innerHTML = '';
      for (var key in e.feature) {
        innerHTML += key +'<br>'+ e.feature[key] +'<br>';
      }
      tooltip.innerHTML     = innerHTML;
      tooltip.style.left    = (e.x+10) +'px';
      tooltip.style.top     = (e.y+10) +'px';
    })
    .on('featureOver', function(e) {
      tooltip.style.left = (e.x+10) +'px';
      tooltip.style.top  = (e.y+10) +'px';
    })
    .on('featureOut', function(e) {
      tooltip.style.display = 'none';
    })
    .on('featureClick', function(e) {
//      tooltip.innerHTML += ' clicked';
    });

  L.control.layers({}, { VECNIK: vlayer }).addTo(map);
});

</script>
</head>

<body>
<div id="map"></div>
<div id="tooltip"></div>
</body>
</html>