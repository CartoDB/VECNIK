<!DOCTYPE html>
<html>
<head>
<title>Vecnik</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<link rel="stylesheet" href="lib/leaflet08/leaflet.css">
<style type="text/css">
html, body {
  border: 0;
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

#map {
  height: 100%;
}

.control {
  display: block;
  border: 0;
  font-size: 12px;
  padding: 5px;
  background-color: rgba(255, 250, 245, 0.85);
  border-radius: 5px;
  box-shadow: 0 0 5px #999;
  position: absolute;
  left: 10px;
  width: 300px;
  z-index: 10;
}

#user {
  top: 75px;
}

#table {
  top: 115px;
}

#columns {
  top: 155px;
}

#code {
  top: 195px;
  bottom: 10px;
}
</style>

<script src="lib/leaflet08/leaflet-src.js"></script>
<script src="../vecnik.debug.js"></script>
<script src="lib/underscore.js"></script>
<script src="lib/carto.js"></script>
<script>

var
  map,
  userControl,
  tableControl,
  columnsControl,
  codeControl;

var provider = new VECNIK.CartoDB.API({
  user: 'pluto',
  table: 'mn_mappluto_13v1',
  columns: ['numfloors'],
  debug: false,
  bufferSize: 50
});

var shader = new VECNIK.CartoShader();

var renderer = new VECNIK.Renderer({ shader: shader });

var vlayer = new VECNIK.Layer({
  provider: provider,
  renderer: renderer
});

function updateProvider() {
  provider.update({
    user: userControl.value,
    table: tableControl.value,
    columns: columnsControl.value.replace(/[,; ]+/, ';').split(';')
  });
  vlayer.redraw(true);
}

function updateShader() {
  shader.update(codeStr = code.value);
  vlayer.redraw();
}

document.addEventListener('DOMContentLoaded', function() {
  userControl = document.getElementById('user');
  tableControl = document.getElementById('table');
  columnsControl = document.getElementById('columns');
  codeControl = document.getElementById('code');

  map = new L.Map('map').setView([40.735291, -73.990731], 16);
  new L.TileLayer('http://otile2.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.png', { maxNativeZoom: 19, maxZoom: 21 }).addTo(map);

  vlayer.addTo(map);
  L.control.layers({}, { VECNIK: vlayer }).addTo(map);

  userControl.addEventListener('change', updateProvider);
  tableControl.addEventListener('change', updateProvider);
  columnsControl.addEventListener('change', updateProvider);

  var timer, codeStr = '';
  codeControl.addEventListener('change', function() {
    if (codeStr === codeControl.value) {
      return;
    }
    clearTimeout(timer);
    timer = setTimeout(updateShader, 750);
  });

  updateShader();
});
</script>
</head>

<body>
<div id="map"></div>

<input type="text" class="control" id="user" value="pluto">
<input type="text" class="control" id="table" value="mn_mappluto_13v1">
<input type="text" class="control" id="columns" value="numfloors">
<textarea class="control" id="code">
#layer {
  polygon-fill: rgba(0, 0, 0, 0.1);
  line-color: white;
  line-width: 4;
  [numfloors > 10] {
    polygon-fill: rgba(255, 0, 0, 0.88);
  }
}
#layer::pass2 {
  polygon-fill: rgba(0, 0, 0, 0.0);
  line-width: 1;
  line-color: black;
}
</textarea>
</body>
</html>