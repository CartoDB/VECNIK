<!DOCTYPE html>
<html>
<head>
<title>Vecnik example with OSM data in London</title>

<script src="../src/core/core.js"></script>
<script src="../src/core/events.js"></script>
<script src="../src/core/model.js"></script>
<script src="../src/core/settings.js"></script>
<script src="../src/mercator.js"></script>
<script src="../src/reader/geojson.js"></script>
<script src="../src/models.js"></script>
<script src="../src/renderer.js"></script>
<script src="../src/shader.js"></script>


<script src="../src/provider/cartodb.sql.js"></script>
<script src="../src/provider/cartodb.js"></script>

<script src="stats.js"></script>

<!-- carto -->
<script src="lib/underscore.js"></script>
<script src="lib/carto.js"></script>

<script src="../src/carto.js"></script>

<script>
var map;
function initMap() {
    VECNIK.Carto.init(function(carto) {
        VECNIK.Carto.compile(
          "#world { line-width: 2; line-color: #f00; [TYPEY='test']{ line-width: 2; } [ZOOM = 0]{ line-width: 2; } }"
          , function() {});
    });

    var dataSource = new VECNIK.CartoDB.API({
       user: 'viz2',
       //user: 'jatorre',
       //user: 'staging',
       //user: 'mapnik-tests',
       //table: 'countries_final',
       table: 'roads',
       //table: 'nyc_buildings',
       //table: 'ny_districts',
       //table: 'barcelona_osm_line',
       columns: ['type'], //do not include the_geom or cartodb_id, are implicit
       //columns: ['highway'], //do not include the_geom or cartodb_id, are implicit
       debug: true,
       ENABLE_CLIPPING: true,
       ENABLE_SIMPLIFY: true,
       ENABLE_FIXING: true,
       ENABLE_SNAPPING: true
    });

    var shader = new VECNIK.CartoShader({
        'point-color': '#fff',
        'line-color': '#fff',
        'line-width': function(data) {
            if(data.type === 'primary') {
              return '3';
            }
            return '1';
        },
        'polygon-fill': function(data) {
            return "rgba(200, 200, 200, 0.8)";
        }
    });

    var code = document.getElementById('code');

    var codeOld= '';
    var compileShader = _.debounce(function() {
        VECNIK.Carto.compile(code.value , function(shaderData) {
            if(shaderData) {
              console.log(code.value);
              shader.compile(shaderData);
            }
        });
      }, 200);

    code.onkeyup = function() {
      if(code.value != codeOld) {
        compileShader();
        codeOld = code.value;
      }
    };

    compileShader(code.value);
}
</script>
<style>
html, body, #map {
  width: 100%; height: 100%;
  padding: 0;
  margin: 0;
}

textarea {
  color: rgba(0,0,0,0.9);
  background-color:rgba(255,255,255,0.92);
  position: absolute;
  left: 10px;
  top: 0;
  bottom: 0;
  padding: 0;
  margin: 0;
  border: none;
  font-family: monospace;
  font-size: 14px;
  width: 350px;
  border: 0;
  outline: none;

}
          /* code */
.highlight {
  font-family: monospace;
  font-size: 19px;
}


</style>
</head>
   <body onload="initMap()">
   <div id="map"></div>
  <!--<div id="livecode" class="highlight"></div>-->
   <textarea id="code">
#roads {
  [zoom > 12] {
    line-color: #555;
    line-width: 0.3;
  }
  [type='motorway'],[type='motorway_link'] {
    line-width: 2;
  }
  [type='trunk'], [type='trunk_link'] {
    line-width: 5;
  }
  [type='primary'],   [type='primary_link'] {
    line-width: 5;
  }
  [type='secondary'], [type='secondary_link'] {
    line-width: 2;
    line-color: #222;
  }
}
   </textarea>
</body>
</html>
